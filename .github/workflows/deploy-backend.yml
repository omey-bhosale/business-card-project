name: Deploy Spring Boot Backend to EC2

on:
    push:
        branches:
            - main
        paths:
            - "business-card-backend/**"

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
                uses: actions/checkout@v3

            - name: ☕ Set up Java 17
                uses: actions/setup-java@v3
                with:
                    distribution: "temurin"
                    java-version: "17"

            - name: 🛠️ Build with Maven
                working-directory: business-card-backend
                run: mvn clean package -DskipTests

            - name: 📦 Copy JAR to EC2
                uses: appleboy/scp-action@v0.1.4
                with:
                    host: ${{ secrets.EC2_HOST }}
                    username: ubuntu
                    key: ${{ secrets.EC2_SSH_KEY }}
                    source: business-card-backend/target/*.jar
                    target: /home/ubuntu/app

            - name: 🔫 Kill running Java process (if any)
                uses: appleboy/ssh-action@v1.0.0
                with:
                    host: ${{ secrets.EC2_HOST }}
                    username: ubuntu
                    key: ${{ secrets.EC2_SSH_KEY }}
                    script: |
                        pkill -f 'java' || true

            - name: 🚀 Start Spring Boot using tmux
                uses: appleboy/ssh-action@v1.0.0
                with:
                    host: ${{ secrets.EC2_HOST }}
                    username: ubuntu
                    key: ${{ secrets.EC2_SSH_KEY }}
                    script: |
                        tmux new-session -d -s backend "java -jar /home/ubuntu/app/*.jar > /home/ubuntu/app/log.txt 2>&1"
